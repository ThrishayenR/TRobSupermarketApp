<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <title>Past Orders</title>
    
    <style>
        /* Global & Typography */
        body {
            background-color: #f7f7f7;
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600; 
        }
        .flex-grow-1 {
            flex-grow: 1;
        }

        /* Custom Olive Green Theme */
        .bg-custom-olive {
            background-color: #8fa83e !important;
        }
        .text-custom-olive {
            color: #8fa83e !important;
        }
        .btn-custom-outline-olive {
            color: #8fa83e;
            border-color: #8fa83e;
        }
        .btn-custom-outline-olive:hover {
            background-color: #8fa83e;
            color: white;
        }

        /* Order Card Styling */
        .order-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        /* Order Summary Bar (Header) */
        .order-summary-bar {
            padding: 15px 20px;
            cursor: pointer; /* Indicates clickability */
            background-color: #ffffff;
            transition: background-color 0.2s;
            border-bottom: 1px solid #eee;
        }
        .order-summary-bar:hover {
            background-color: #f0f0f0;
        }

        /* Status Badges */
        .badge-status {
            font-size: 0.8rem;
            padding: 5px 10px;
            font-weight: 600;
        }
        /* Conditional badge colors for better UX */
        .status-completed { background-color: #8fa83e; color: white; }
        .status-pending { background-color: #0d6efd; color: white; }
        .status-cancelled { background-color: #dc3545; color: white; }


        /* Table Styling inside the collapsed body */
        .order-details-table thead th {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
            background-color: #f8f8f8;
        }
        .order-details-table td {
            font-size: 0.9rem;
            padding: 8px;
        }

        /* Total Section */
        .order-total-footer {
            padding: 15px 20px;
            background-color: #fcfcfc;
            border-top: 1px solid #eee;
            font-size: 1.1rem;
        }

    </style>
</head>

<body class="d-flex flex-column min-vh-100">

    <%- include("partials/navbar") %>

    <div class="container mt-4 flex-grow-1">
        <h2>Order History</h2>
        <p class="text-muted">Review all your past and live orders below.</p>

        <% if (orders.length === 0) { %>
            <p class="mt-4">You currently have no orders.</p>
        <% } else { %>

            <div class="accordion mt-3" id="orderAccordion">

                <% orders.forEach(order => { %>
                <% 
                    // Calculate total and determine status style (Mock status logic for design)
                    let total = 0;
                    order.items.forEach(item => { 
                        total += item.price * item.quantity;
                    });
                    
                    // MOCK STATUS LOGIC for better visual UX (Replace with real status logic if available)
                    const statusText = "Completed"; 
                    const statusClass = "status-completed"; // Defaulting to completed/olive
                    
                    // Example of real logic if you had order.status:
                    /* let statusText = order.status || "Processing";
                    let statusClass = "status-pending";
                    if (statusText === "Completed") statusClass = "status-completed";
                    if (statusText === "Cancelled") statusClass = "status-cancelled";
                    */
                %>

                <div class="order-card">

                    <div 
                        class="order-summary-bar d-flex justify-content-between align-items-center"
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse-<%= order.id %>" 
                        aria-expanded="false" 
                        aria-controls="collapse-<%= order.id %>"
                    >
                        
                        <div class="d-flex align-items-center">
                            <span class="badge badge-status <%= statusClass %> me-3"><%= statusText %></span>
                            <strong class="me-3">Order #<%= order.id %></strong>
                            <span class="text-muted small d-none d-md-inline">
                                Placed on: 
                                <%= order.orderDate 
                                    ? new Date(order.orderDate).toLocaleString('en-GB', { dateStyle: "medium", timeStyle: "short" }) 
                                    : "No date available" %>
                            </span>
                        </div>

                        <div class="text-end">
                            <strong class="text-custom-olive me-3">Total: $<%= total.toFixed(2) %></strong>
                            <i class="fas fa-chevron-down ms-2"></i> </div>
                    </div>

                    <div id="collapse-<%= order.id %>" class="collapse" data-bs-parent="#orderAccordion">
                        <div class="card-body p-0">
                            <table class="table order-details-table mb-0 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 100px;">Image</th>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Line Total</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <% 
                                    // Re-calculate total here just for display consistency inside the loop (functionality unchanged)
                                    let itemTotalDisplay = 0; 
                                    order.items.forEach(item => { 
                                        const lineTotal = item.price * item.quantity;
                                        itemTotalDisplay += lineTotal;
                                    %>
                                    <tr>
                                        <td>
                                            <% if (item.image) { %>
                                                <img 
                                                    src="images/<%= item.image %>" 
                                                    class="img-thumbnail"
                                                    style="width: 70px; height: 70px; object-fit: cover;"
                                                >
                                            <% } else { %>
                                                <span class="text-muted">No image</span>
                                            <% } %>
                                        </td>
                                        <td><%= item.productName %></td>
                                        <td><%= item.quantity %></td>
                                        <td>$<%= item.price.toFixed(2) %></td>
                                        <td>$<%= lineTotal.toFixed(2) %></td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="order-total-footer text-end">
                            <a href="/invoice/<%= order.id %>" class="btn btn-sm btn-custom-outline-olive me-2">View Invoice</a>
                            <a href="/cart" class="btn btn-sm btn-custom-outline-olive">Reorder</a>
                        </div>
                    </div>

                </div> <% }) %>
            </div> <% } %>

    </div>

    <%- include("partials/footer") %>

<script src="https://kit.fontawesome.com/your-fontawesome-kit-id.js" crossorigin="anonymous"></script> 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>