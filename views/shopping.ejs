<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Supermarket App</title>
</head>
<body>
  
  <%- include("partials/navbar") %>

  <% if (messages && messages.length > 0) { %>
  <div class="alert alert-danger mt-3">
    <% messages.forEach(function(message) { %>
      <p><%= message %></p>
    <% }); %>
  </div>
  <% } %>

  <% if (success && success.length > 0) { %>
    <div class="alert alert-success mt-3">
      <% success.forEach(function(message) { %>
        <p><%= message %></p>
      <% }); %>
    </div>
  <% } %>


  <div class="container">
    <p>Welcome, <%= user.username %> (<%= user.role %>)</p>
    <br>
    <div class="text-center"><h2>Products from Supermarket</h2></div>
    <br>
    <table class="table table-hover small text-center">
      <thead>
          <tr>
            <th width="100">Product Name</th>
            <th width="100">Product Image</th>
            <th width="50">Quantity</th>
            <th width="50">Price</th>
            <th width="50">Quantity</th>
            <th width="50">Buy</th>
          </tr>
      </thead>
      <tbody>
        <% for(let i=0; i < products.length; i++) { %>
          <tr>
            <td><a href="/product/<%= products[i].id %>" ><%= products[i].productName %></a></td>
            <td><img src = "images/<%= products[i].image %>" width="20%"></td>
            <td>
              <% if (products[i].quantity === 0) { %>
                <span class="badge bg-danger text-white" style="font-size: 0.8rem;">Out of stock</span>
              <% } else { %>
                <%= products[i].quantity %>
              <% } %>
            </td>
            <td>$<%= products[i].price.toFixed(2) %></td>
            <!-- <td>
              <select id="role" name="role" class="form-control" >
                <option value="1" selected >1</option>
                <option value="2" >2</option>
                <option value="3" >3</option>
                <option value="4" >4</option>
                <option value="5" >5</option>
              </select>
            </td> -->
            <!-- Buy Link -->
            <!-- <td><a href="/buyProduct/<%#= products[i].id %>" class="btn btn-primary mt-3">Buy</a></td> -->
            
            <td>
              <div class="input-group" style="max-width: 140px;">
                
                <!-- minus button -->
                <button 
                  type="button"
                  class="btn btn-outline-secondary"
                  onclick="
                    const input = document.getElementById('qty-<%= products[i].id %>');
                    input.value = Math.max(1, Number(input.value) - 1);
                    updateHidden(<%= products[i].id %>);
                  "
                >-</button>

                <!-- visible quantity -->
                <input 
                  id="qty-<%= products[i].id %>" 
                  type="number"
                  class="form-control text-center"
                  value="1"
                  min="1"
                  oninput="
                    this.value = this.value.replace(/[^0-9]/g, '');
                    updateHidden(<%= products[i].id %>);
                  "
                >

                <!-- plus button -->
                <button 
                  type="button"
                  class="btn btn-outline-secondary"
                  onclick="
                    const input = document.getElementById('qty-<%= products[i].id %>');
                    input.value = Number(input.value) + 1;
                    updateHidden(<%= products[i].id %>);
                  "
                >+</button>

              </div>
            </td>

            <td>
              <form action="/add-to-cart/<%= products[i].id %>" method="POST">
                <!-- hidden input the backend reads -->
                <input 
                  type="hidden" 
                  name="quantity" 
                  id="quantity-<%= products[i].id %>" 
                  value="1"
                >
                <button type="submit" class="btn btn-primary mt-3">Buy</button>
              </form>
            </td>

            <!-- quantity sync script -->
            <script>
              function updateHidden(id) {
                const visible = document.getElementById('qty-' + id);
                const hidden = document.getElementById('quantity-' + id);
                hidden.value = visible.value;
              }
            </script>


          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
  <%- include("partials/footer") %>
  
</body>
</html>
